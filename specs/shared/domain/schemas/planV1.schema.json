{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Plan IR (plan_v1)",
  "type": "object",
  "description": "Intermediate Representation for deterministic transformations executed server-side by PlanExecutor.",
  "required": [
    "steps"
  ],
  "properties": {
    "recordPath": {
      "description": "JSON Pointer-like path to the array of records to process (e.g. '/', '/items', '/results/forecast'). If omitted/null, the generator MAY discover it (RecordPathDiscovery).",
      "type": [
        "string",
        "null"
      ]
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "oneOf": [
          {
            "title": "SelectStep",
            "type": "object",
            "required": [
              "op"
            ],
            "properties": {
              "op": {
                "const": "select"
              },
              "fields": {
                "description": "List of fields to project. Use ['*'] or omit fields to mean 'select all', depending on template.",
                "type": "array",
                "items": {
                  "type": "string"
                },
                "minItems": 1
              }
            },
            "additionalProperties": true
          },
          {
            "title": "FilterStep",
            "type": "object",
            "required": [
              "op",
              "where"
            ],
            "properties": {
              "op": {
                "const": "filter"
              },
              "where": {
                "description": "Predicate definition. Exact shape is engine-defined; this schema is permissive to allow evolution.",
                "type": "object",
                "properties": {
                  "field": {
                    "type": "string"
                  },
                  "eq": {},
                  "neq": {},
                  "in": {
                    "type": "array"
                  },
                  "contains": {},
                  "gt": {},
                  "gte": {},
                  "lt": {},
                  "lte": {},
                  "isNull": {
                    "type": "boolean"
                  },
                  "isNotNull": {
                    "type": "boolean"
                  }
                },
                "additionalProperties": true
              }
            },
            "additionalProperties": true
          },
          {
            "title": "GroupByStep",
            "type": "object",
            "required": [
              "op",
              "keys",
              "aggregates"
            ],
            "properties": {
              "op": {
                "const": "groupBy"
              },
              "keys": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "minItems": 1
              },
              "aggregates": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "required": [
                    "func"
                  ],
                  "properties": {
                    "field": {
                      "type": "string"
                    },
                    "func": {
                      "type": "string",
                      "enum": [
                        "sum",
                        "avg",
                        "min",
                        "max",
                        "count"
                      ]
                    },
                    "as": {
                      "type": "string"
                    }
                  },
                  "additionalProperties": true
                }
              }
            },
            "additionalProperties": true
          },
          {
            "title": "MapValueStep",
            "type": "object",
            "required": [
              "op",
              "field",
              "mapping"
            ],
            "properties": {
              "op": {
                "const": "mapValue"
              },
              "field": {
                "type": "string"
              },
              "mapping": {
                "type": "object",
                "additionalProperties": {
                  "type": [
                    "string",
                    "number",
                    "boolean",
                    "null"
                  ]
                }
              },
              "default": {
                "type": [
                  "string",
                  "number",
                  "boolean",
                  "null"
                ]
              }
            },
            "additionalProperties": true
          },
          {
            "title": "LimitStep",
            "type": "object",
            "required": [
              "op",
              "take"
            ],
            "properties": {
              "op": {
                "const": "limit"
              },
              "take": {
                "type": "integer",
                "minimum": 0
              }
            },
            "additionalProperties": true
          },
          {
            "title": "UnknownStep",
            "type": "object",
            "required": [
              "op"
            ],
            "properties": {
              "op": {
                "type": "string"
              }
            },
            "additionalProperties": true
          }
        ]
      }
    },
    "meta": {
      "description": "Optional metadata (e.g., source='llm'|'template:T2'|'explicit', templateId, promptVersion).",
      "type": "object",
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}
